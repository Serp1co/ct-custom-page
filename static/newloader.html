<!---- START CUSTOM SECTION -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
<style>
    .body_box, .ritratto, .profilo * {
        border: none !important;
    }
    #app {
        height: 600px;
        width: 564px;
        position: relative;
        display: block;
        border: 1px solid dimgray!important;
    }

    #loader #spinner {
        -webkit-animation: spinner-anim 2s ease-out infinite;
        animation: spinner-anim 2s ease-out infinite;
    }

    #loader #spinner::before {
        -webkit-animation: spinner-anim 2s ease-out infinite;
        animation: spinner-anim 2s ease-out infinite;
    }

    #loader #spinner::after {
        -webkit-animation: spinner-anim 1s ease-out infinite;
        animation: spinner-anim 1s ease-out infinite;
    }

    #loader {
        position: absolute;
        bottom: 0;
        left: 0;
        z-index: 11;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        opacity: 0.7;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }

    #loader #loading-text {
        font-size: 1.8em;
        font-family: "Consolas", sans-serif;
        color: ghostwhite;
        transition: all 0.5s ease-in-out;
    }

    #loader #spinner {
        height: 40px;
        width: 40px;
        border: 2px solid whitesmoke;
        border-color: transparent transparent ghostwhite ghostwhite;
        border-radius: 50%;
        margin-right: 10px;
        transform: rotate(0deg);
    }

    #loader #spinner::before, #loader #spinner::after {
        position: absolute;
        content: "";
        display: block;
        border: 2px solid;
        border-color: transparent transparent ghostwhite ghostwhite;
        border-radius: 50%;
    }

    #loader #spinner::before {
        top: 3px;
        left: 3px;
        height: 30px;
        width: 30px;
    }

    #loader #spinner::after {
        top: 8px;
        left: 8px;
        height: 20px;
        width: 20px;
    }

    #loginform {
        border: 1px solid grey;
        color: dimgrey;
        font-family: "Consolas", sans-serif;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.5s;
        position: absolute;
        padding: 1rem 1rem 0.8rem 1rem;
        top: 50%;
        left: 50%;
        transform: translateX(-50%) translateY(-50%);
        z-index: 4;
    }

    #startbtn {
        border: 1px solid grey;
        color: dimgrey;
        font-family: "Consolas", sans-serif;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.5s;
        padding: 1rem 1rem 0.8rem 1rem;
    }

    #startbtn:hover {
        border: 1px solid ghostwhite;
        background: black;
        color: ghostwhite;
    }

    #section {
        height: 600px;
        transition: opacity 0.5s ease-in-out;
    }

    .hidden {
        opacity: 0 !important;
    }

    #initloader {
        color: dimgrey;
        font-family: "Consolas", sans-serif;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.5s;
    }
</style>
<script type="text/javascript">
    class CookieCutter {
        static getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = document.cookie;
            console.log(decodedCookie);
            let ca = decodedCookie.split(";");
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === " ") {
                    c = c.substring(1);
                    console.log(c);
                }
                if (c.indexOf(name) === 0) {
                    console.log(c.substring(name.length, c.length));
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    }
    class _Resource {
        static resource_target = "http://localhost/static";
        //static resource_target = "https://raw.githubusercontent.com/Serp1co/ct-custom-page/feature/class/static/";

        url;
        type;
        _elem;

        constructor(url, type) {
            this.url = _Resource.resource_target + url;
            this.type = type;
        }

        async initResource() {
            this._elem = await _ResourceFetcher._fetch_resource(this);
        }

        getElem() {
            return this._elem.cloneNode(true);
        }
    }

    class _ResourceFetcher {
        static async _fetch_resource(resource) {
            return await fetch(resource.url, {
                method: "GET", // *GET, POST, PUT, DELETE, etc.
                mode: "cors", // no-cors, *cors, same-origin
                cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
            })
                .then((response) => _ResourceFetcher._process_response(response))
                .then((data) => {
                    let html = document.createElement(resource.type);
                    html.innerHTML = data;
                    return html;
                })
                .catch((exception) => console.error(exception))
        }

        static async _process_response(response) {
            if (response.ok) return response.text();
            else
                throw {
                    status_code: response.status,
                    status_description: response.statusText,
                };
        };
    }

    class Component {
        static COMPONENTS = {};

        name;
        html;
        _style;
        _script;

        constructor(name, path) {
            this.name = name;
            this._style = new _Resource(path + "/" + name + "/" + name + ".css", "style");
            this._script = new _Resource(path + "/" + name + "/" + name + ".js", "script");
            this.html = new _Resource(path + "/" + name + "/" + name + ".html", "div");
        }

        async initComponent() {
            await this._fetch_elements()
                .then((_) => {
                    document.head.appendChild(this._style.getElem());
                    document.body.appendChild(this._script.getElem());
                })
                .then((_) => this._propagate_init_event())
                .catch((exception) => console.error(JSON.parse(exception)));
        }

        async _fetch_elements() {
            await this._style.initResource();
            await this._script.initResource();
            await this.html.initResource();
        }

        _propagate_init_event() {
            document.dispatchEvent(new Event("component-" + this.name + "-init-done"));
        }

        static renderComponent(component, parent, id, classlist = []) {
            let item = component.html.getElem();
            item.id = id;
            item.classList.add(...classlist);
            Component.COMPONENTS[id] = parent.appendChild(item);
        }

        static removeComponent(id) {
            Component.COMPONENTS[id].remove();
        }
    }

    class App {
        constructor() {
            this.section = new Component("section", COMPONENT_PATH);
            this.audiomanager = new Component("audiomanager", COMPONENT_PATH);
            this.background = new Component("background", COMPONENT_PATH);
            this.glitchimage = new Component("glitchimage", COMPONENT_PATH);
            this.crt = new Component("crt", COMPONENT_PATH);
        }

        async initApp() {
            await this.section.initComponent();
            await this.audiomanager.initComponent();
            await this.background.initComponent();
            await this.glitchimage.initComponent();
            await this.crt.initComponent();
        }
    }

    const COMPONENT_PATH = "/components";

    window.onload = function () {
        let template = document.querySelector("#app");
        let startBtn = document.querySelector("#startbtn");
        let initLoader = document.querySelector("#initloader");
        let loginForm = document.querySelector("#loginform");
        let app = new App();
        app.initApp()
            .then(() => {
                Component.renderComponent(app.section, template, "section", ["hidden"]);
                Component.renderComponent(app.audiomanager, template, "audiomanager");
                Component.renderComponent(app.background, template, "background");
                Component.renderComponent(app.crt, template, "crt", ["crt"]);
                let glitch = new GlitchedImage(document.querySelector("#bottomimg"), 180);
                let audiomanager = new AudioManager();
                let background = new Background(document.querySelector("#backgroundcanvas"), 564, 600);
                startBtn.addEventListener("click", () => {
                    background.loop();
                    glitch.init();
                    audiomanager.audioCtx.resume();
                    loginForm.classList.add("hidden");
                    audiomanager.loadAudio().then(() => {
                        loginForm.remove();
                        document.querySelector("#section").classList.remove("hidden");
                        glitch.render();
                    });
                });
            })
            .finally(() => {
                initLoader.remove();
                loginForm.classList.remove("hidden");
                let username = CookieCutter.getCookie("lastlogin");
                document.querySelector(".inittext").innerHTML = "Welcome, " + username + ".<br>Remember: I See You.<br>";
            });
    }
</script>
<div id="app">
    <div id="loginform" class="hidden">
        <p><a id="startext" class="inittext"></a></p>
        <p style="text-align: center;padding: 10px 0 0 0;"><a id="startbtn">Login</a></p>
    </div>
    <div id="loader" class="hidden">
        <div id="spinner"></div>
        <h2 id="loading-text">Loading...</h2>
    </div>
    <div id="initloader" class="visible">
        <h2>Loading...</h2>
    </div>
</div>
<!---- END CUSTOM SECTION -->
<div class="col server_footer" id="server_footer_div">
    <div class="server_footer">
        This server is property of Ash Williams, any connection and access will be
        reported, all actions are under strict auditing.
    </div>
    <div class="server_footer">
        Malicious actions <a class="tip">w i l l</a> be persecuted.
    </div>
</div>
<br />
<hr />
<div>
    Source code available under Apache 2.0 License: <a href="https://github.com/Serp1co/ct-custom-page">github@serp1c0/ct-custom-page</a>
</div>
<div>
    Branch: feature/class
</div>
<div>
    Work in progress is updated live everytime I push on the repo :)
</div>